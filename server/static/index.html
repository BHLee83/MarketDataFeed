<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시장 데이터 모니터링</title>
    <style>
        .data-container { margin: 20px; }
        .chart-container { height: 400px; }
        #tickTable { width: 100%; border-collapse: collapse; }
        #tickTable th, #tickTable td { 
            padding: 8px; 
            text-align: right; 
        }
        #tickTable th:nth-child(1), #tickTable td:nth-child(1), 
        #tickTable th:nth-child(2), #tickTable td:nth-child(2) { 
            text-align: center; 
        }
    </style>
</head>
<body>
    <div class="data-container">
        <h2>실시간 체결 데이터</h2>
        <table id="tickTable" border="1">
            <thead>
                <tr>
                    <th>시간</th>
                    <th>종목코드</th>
                    <th>가격</th>
                    <th>거래량</th>
                    <th>소스</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="data-container">
        <h2>분봉 데이터</h2>
        <div id="minuteChart" class="chart-container"></div>
    </div>

    <div class="data-container">
        <h2>거래량 프로파일</h2>
        <div id="volumeProfile" class="chart-container"></div>
    </div>

    <script>
        // 종목별 행 인덱스를 저장하는 객체
        const itemRows = {};
        
        function updateTickTable(data) {
            const table = document.getElementById('tickTable').getElementsByTagName('tbody')[0];
            
            // data 배열의 각 항목에 대해 처리
            data.forEach(idx => {
                const content = idx.content;
                // content 배열의 각 항목에 대해 처리
                content.forEach(tick => {
                    const itemCode = tick.item_code || '-';
                    const rowData = [
                        new Date(idx.timestamp).toLocaleTimeString(),
                        itemCode,
                        tick.current_price,
                        tick.current_vol,
                        idx.source
                    ];
                    
                    if (itemCode in itemRows) {
                        // 기존 행 업데이트
                        const row = table.rows[itemRows[itemCode]];
                        for (let i = 0; i < rowData.length; i++) {
                            row.cells[i].textContent = rowData[i];
                        }
                    } else {
                        // 새로운 행 추가
                        const row = table.insertRow(0);
                        itemRows[itemCode] = 0;
                        
                        // 기존 행들의 인덱스 업데이트
                        for (let code in itemRows) {
                            if (code !== itemCode) {
                                itemRows[code]++;
                            }
                        }
                        
                        // 새 행에 데이터 추가
                        rowData.forEach(text => {
                            const cell = row.insertCell();
                            cell.textContent = text;
                        });
                    }
                    
                    // 테이블 크기 제한 (예: 최대 100개 종목)
                    // while (table.rows.length > 100) {
                    //     const lastRow = table.rows[table.rows.length - 1];
                    //     const lastItemCode = lastRow.cells[1].textContent;
                    //     delete itemRows[lastItemCode];
                    //     table.deleteRow(table.rows.length - 1);
                    // }
                });
            });
        }

        // WebSocket 연결 및 재연결 관리
        let ws = null;
        
        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/market-data`);
            
            ws.onopen = function() {
                console.log('WebSocket 연결됨');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('받은 데이터:', data);  // 데이터 구조 확인용 로그
                
                switch(data.type) {
                    case 'tick_data':
                        updateTickTable(data.data);
                        break;
                    case 'minute_data':
                        updateMinuteChart(data);
                        break;
                    case 'statistics_data':
                        updateStatistics(data);
                        break;
                    case 'chart_data':
                        updateCharts(data);
                        break;
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket 연결이 끊어졌습니다. 재연결을 시도합니다...');
                setTimeout(connectWebSocket, 1000);
            };
            
            ws.onerror = function(err) {
                console.error('WebSocket 오류:', err);
                ws.close();
            };
        }
        
        // 초기 연결 시작
        connectWebSocket();

        function updateMinuteChart(minuteData) {
            // Chart.js나 다른 차트 라이브러리를 사용하여 분봉 차트 업데이트
        }

        function updateStatistics(statsData) {
            // 통계 데이터 업데이트 (거래량 프로파일, 가격대별 거래량 등)
        }

        function updateCharts(chartData) {
            // 차트 데이터 업데이트
        }
    </script>
</body>
</html>
